services:
  # Database service - MariaDB
  # Note: You can switch to PostgreSQL by uncommenting the postgres service below
  db:
    image: mariadb:lts
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    restart: unless-stopped
    volumes:
      - db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-changeme_root}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-changeme}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-nextcloud}
      - MYSQL_USER=${MYSQL_USER:-nextcloud}
      - MARIADB_AUTO_UPGRADE=1
      - MARIADB_DISABLE_UPGRADE_BACKUP=1
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Uncomment this section to use PostgreSQL instead of MariaDB
  # postgres:
  #   image: postgres:alpine
  #   restart: unless-stopped
  #   volumes:
  #     - db:/var/lib/postgresql/data:Z
  #   environment:
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
  #     - POSTGRES_DB=${POSTGRES_DB:-nextcloud}
  #     - POSTGRES_USER=${POSTGRES_USER:-nextcloud}
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # Redis for caching
  redis:
    image: redis:alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Nextcloud application
  # Using official pre-built image (faster and more reliable)
  # To build from local Dockerfile instead, uncomment the build section and comment the image line
  app:
    image: nextcloud:32-apache
    # build:
    #   context: .
    #   dockerfile: 32/apache/Dockerfile
    restart: unless-stopped
    ports:
      - "${NEXTCLOUD_PORT:-8080}:80"
    volumes:
      - nextcloud:/var/www/html
    environment:
      - MYSQL_HOST=db
      - MYSQL_DATABASE=${MYSQL_DATABASE:-nextcloud}
      - MYSQL_USER=${MYSQL_USER:-nextcloud}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-changeme}
      - REDIS_HOST=redis
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER:-admin}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD:-changeme}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_TRUSTED_DOMAINS:-localhost}
      - OVERWRITEPROTOCOL=${OVERWRITEPROTOCOL:-http}
      - OVERWRITEHOST=${OVERWRITEHOST:-localhost:8080}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nextcloud cron job
  # Using official pre-built image (faster and more reliable)
  # To build from local Dockerfile instead, uncomment the build section and comment the image line
  cron:
    image: nextcloud:32-apache
    # build:
    #   context: .
    #   dockerfile: 32/apache/Dockerfile
    restart: unless-stopped
    volumes:
      - nextcloud:/var/www/html
    entrypoint: /cron.sh
    depends_on:
      - db
      - redis

volumes:
  nextcloud:
  db:
